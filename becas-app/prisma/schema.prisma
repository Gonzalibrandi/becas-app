generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum AlertFrequency {
  DAILY
  WEEKLY
}

// ============================================
// SCHOLARSHIP & CATEGORIES
// ============================================

model Scholarship {
  id             String    @id @default(uuid())
  slug           String    @unique
  
  // Main content
  title          String
  description    String    @default("")
  
  // URLs
  applyUrl       String?   @map("apply_url")
  officialUrl    String?   @map("official_url")
  sourceUrl      String    @map("source_url")
  
  // Key data
  deadline       DateTime?
  startDate      DateTime? @map("start_date")
  
  // Classification
  fundingType    String    @default("UNKNOWN") @map("funding_type")
  educationLevel String    @default("OTHER") @map("education_level")
  
  // Rich content (legacy field - will be migrated to categories)
  benefits       String    @default("")
  requirements   String    @default("")
  duration       String    @default("")
  
  // Relations
  categories     Category[] @relation("ScholarshipCategories")          // Many-to-Many with Category
  savedByUsers   User[]    @relation("SavedScholarships") // Many-to-Many favorites
  countries      Country[] @relation("ScholarshipCountries")
  
  // Admin
  status         String    @default("DRAFT")
  rawData        String    @default("{}") @map("raw_data")
  adminNotes     String?   @map("admin_notes")
  isRecommended  Boolean   @default(false) @map("is_recommended")
  
  // Timestamps
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Indexes for query optimization
  @@index([status, createdAt])
  @@index([fundingType])
  @@index([educationLevel])
  @@index([deadline])

  @@map("scholarships")
}

model Category {
  id            String        @id @default(uuid())
  name          String        @unique  // "Ingeniería"
  slug          String        @unique  // "ingenieria"
  
  // Relations
  scholarships  Scholarship[] @relation("ScholarshipCategories")
  
  // Timestamps
  createdAt     DateTime      @default(now()) @map("created_at")

  @@map("categories")
}

// ============================================
// USERS & AUTH
// ============================================

model AdminUser {
  id           String   @id @default(uuid())
  username     String   @unique
  passwordHash String   @map("password_hash")
  email        String?
  isActive     Boolean  @default(true) @map("is_active")
  lastLogin    DateTime? @map("last_login")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("admin_users")
}

model User {
  id           String   @id @default(uuid())
  firstName    String
  lastName     String
  username     String   @unique
  passwordHash String   @map("password_hash")
  email        String   @unique
  isActive     Boolean  @default(true) @map("is_active")
  lastLogin    DateTime? @map("last_login")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  savedScholarships Scholarship[]      @relation("SavedScholarships") // Favorites
  alerts            ScholarshipAlert[]

  @@map("users")
}

// ============================================
// ALERTS / SAVED SEARCHES
// ============================================

model ScholarshipAlert {
  id          String          @id @default(uuid())
  name        String          @default("Mi Alerta")
  
  // Search criteria stored as JSON
  // Example: { "categories": ["ingenieria"], "countries": ["España"], "fundingType": "FULL" }
  criteria    Json            @default("{}")
  
  // Notification settings
  frequency   AlertFrequency  @default(WEEKLY)
  isActive    Boolean         @default(true) @map("is_active")
  lastSentAt  DateTime?       @map("last_sent_at")
  
  // Relations
  userId      String          @map("user_id")
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  @@index([userId])
  @@index([isActive])

  @@map("scholarship_alerts")
}

// ============================================
// EMAILS
// ============================================

model Email {
  id           String   @id @default(uuid())
  to           String
  subject      String
  body         String
  sentAt       DateTime @default(now()) @map("sent_at")
  
  @@map("emails")
}

// ============================================
// COUNTRIES
// ============================================

model Country {
  id           String    @id @default(uuid())
  name         String    @unique
  isoCode      String?   @unique
  slug         String    @unique
  
  // Relations
  scholarships Scholarship[] @relation("ScholarshipCountries")

  @@map("countries")
}

